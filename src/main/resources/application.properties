spring.application.name=valetKey
server.port=8080
server.address=0.0.0.0
spring.application.instance-id=${HOSTNAME:${random.value}}
#spring.datasource.driver-class-name=org.postgresql.Driver
## Disable prepared statement caching to avoid "prepared statement already exists" error
## This is needed for Supabase Transaction mode connection pooling
#spring.datasource.url=jdbc:postgresql://aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres?prepareThreshold=0&preparedStatementCacheQueries=0
#spring.datasource.username=postgres.kelsjjbbiasblwqccpbt
#spring.datasource.password=123456
management.endpoint.health.probes.enabled=true


# Connection Pool Configuration (HikariCP)
# Transaction mode (port 6543) allows more connections than Session mode
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.idle-timeout=180000
spring.datasource.hikari.max-lifetime=600000
spring.datasource.hikari.leak-detection-threshold=15000
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.pool-name=ValetKeyHikariPool
spring.datasource.hikari.auto-commit=true

# JPA/Hibernate Configuration
#spring.jpa.show-sql=false
# Transaction mode (port 6543) allows more connections, safe to use 'update'
# Hibernate will create missing tables automatically
#spring.jpa.hibernate.ddl-auto=update
#spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
#spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
#spring.jpa.properties.hibernate.globally_quoted_identifiers=true
#spring.jpa.properties.hibernate.globally_quoted_identifiers_skip_column_definitions=true

# Close idle connections
spring.jpa.properties.hibernate.connection.provider_disables_autocommit=false
spring.jpa.properties.hibernate.connection.handling_mode=delayed_acquisition_and_release_after_transaction

# Force flush and clear to release connections faster
spring.jpa.properties.hibernate.flush_mode=commit
spring.jpa.properties.hibernate.jdbc.batch_size=20

# File Upload Configuration - Allow large files up to 1GB
spring.servlet.multipart.max-file-size=1GB
spring.servlet.multipart.max-request-size=1GB
spring.servlet.multipart.file-size-threshold=10MB
spring.servlet.multipart.resolve-lazily=true

# HTTP Request timeout for large files (extended for 1GB files)
server.tomcat.connection-timeout=600000
server.tomcat.max-swallow-size=1GB

azure.storage.connection-string=${AZURE_CONNECTION_STRING}
azure.storage.container-name=valet-demo

management.endpoints.web.exposure.include=health,metrics,prometheus,circuitbreakers,ratelimiters
management.endpoint.metrics.enabled=true
management.endpoint.health.show-details=always
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true

# Resilience4j Circuit Breaker Configuration
resilience4j.circuitbreaker.instances.azureService.registerHealthIndicator=true
resilience4j.circuitbreaker.instances.azureService.slidingWindowSize=10
resilience4j.circuitbreaker.instances.azureService.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.azureService.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.instances.azureService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.azureService.waitDurationInOpenState=60s
resilience4j.circuitbreaker.instances.azureService.failureRateThreshold=50
resilience4j.circuitbreaker.instances.azureService.eventConsumerBufferSize=10
resilience4j.circuitbreaker.instances.azureService.slowCallRateThreshold=100
resilience4j.circuitbreaker.instances.azureService.slowCallDurationThreshold=5s

# Resilience4j Retry Configuration
resilience4j.retry.instances.azureService.maxAttempts=3
resilience4j.retry.instances.azureService.waitDuration=2s
resilience4j.retry.instances.azureService.enableExponentialBackoff=true
resilience4j.retry.instances.azureService.exponentialBackoffMultiplier=4
resilience4j.retry.instances.azureService.retryExceptions=java.lang.Exception
resilience4j.retry.instances.azureService.ignoreExceptions=java.lang.IllegalArgumentException
logging.level.io.github.resilience4j.retry=DEBUG
logging.level.io.github.resilience4j.circuitbreaker=DEBUG
logging.level.io.github.resilience4j.core=DEBUG
resilience4j.circuitbreaker.circuitBreakerAspectOrder=1
resilience4j.retry.retryAspectOrder=2


# Redis Cache Configuration
spring.cache.type=redis
spring.cache.redis.time-to-live=600000
spring.cache.redis.cache-null-values=false
spring.cache.redis.use-key-prefix=true
spring.cache.redis.key-prefix=cache:

spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://db:3306/mydb
spring.datasource.username=root
spring.datasource.password=secret

# Hibernate
spring.jpa.hibernate.ddl-auto=update

# Chon Dialect MySQL
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
# Hoac dung:
# spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

# Tuy chon cho ten bang/cot neu muon quote
spring.jpa.properties.hibernate.globally_quoted_identifiers=true
spring.jpa.properties.hibernate.globally_quoted_identifiers_skip_column_definitions=true

# Redis Configuration for Bucket4j Rate Limiting
spring.data.redis.host=redis
spring.data.redis.port=6379
spring.data.redis.password=
spring.data.redis.database=0
spring.data.redis.timeout=2000ms
spring.data.redis.lettuce.pool.enabled=true
spring.data.redis.lettuce.pool.max-active=8
spring.data.redis.lettuce.pool.max-idle=8
spring.data.redis.lettuce.pool.min-idle=0
spring.data.redis.lettuce.pool.max-wait=-1ms

# Spring Session Redis Configuration
spring.session.store-type=redis
spring.session.redis.flush-mode=immediate
spring.session.redis.namespace=spring:session
spring.session.timeout=1800

# Cookie configuration for Spring Session
# For localhost development, use SameSite=Lax (not None which requires HTTPS)
server.servlet.session.cookie.name=SESSION
server.servlet.session.cookie.http-only=false
server.servlet.session.cookie.secure=false
server.servlet.session.cookie.same-site=lax
server.servlet.session.cookie.path=/
server.servlet.session.cookie.max-age=1800

# Logging for debugging session
logging.level.org.springframework.session=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web=DEBUG